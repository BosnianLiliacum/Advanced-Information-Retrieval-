Post Title: Decrypt secrets through ArgoCD
Author: Pupsie_lover
Score: 3
URL: https://www.reddit.com/r/selfhosted/comments/1eaef5p/decrypt_secrets_through_argocd/
Number of comments: 1
Created UTC: 2024-07-23 17:58:06

Post Content:
Hello all, I have a [homelab ](https://github.com/chaitanya2692/my-homelab)hosted on a k3s ubuntu server. I used to previously deploy all services to the htpc namespace using a couple of bash scripts: [update-manifests.sh](http://update-manifests.sh) and [deploy.sh](https://github.com/chaitanya2692/my-homelab/blob/main/scripts/deploy.sh).

I am right now trying to learn how to use ArgoCD to automate the deployment. The aim of [this PoC](https://github.com/chaitanya2692/my-homelab/pull/18) is to have argocd in the argocd namespace and all other services in the htpc namespace. The PoC is supposed to deploy argocd and the htpc services in their respective namespaces.

It was easy to decrypt secrets through a bash script before deploying. In ArgoCD, I have implemented a [pre-sync-hook.yaml](https://github.com/chaitanya2692/my-homelab/pull/18/files#diff-b8072acfd5d683b3d15ff44bc5ba4b438f7f1123d9e929897be7d977d1d159a0) to decrypt my secrets. My question is, does the ArgoCD service need the htpc namespace and the secret to exist before it can decrypt it? If yes, should I change the pre-sync-hook script to?

    set -e SOPS_AGE_KEY_FILE=/keys/keys.txt
    AGE_PUBLIC_KEY=$(grep -oP "public key: \K(.*)" "$SOPS_AGE_KEY_FILE") kubectl create namespace htpc --dry-run=client -o yaml | kubectl apply -f - kubectl get secrets -n htpc -o json | jq -r '.items[] | select(.data | to_entries[] | select(.value | contains("BEGIN AGE ENCRYPTED FILE"))) | .metadata.name' | while read -r secret_name; do 
      echo "Decrypting secret: $secret_name" 
      kubectl get secret $secret_name -n htpc -o yaml | sops --decrypt --age "$AGE_PUBLIC_KEY" --encrypted-regex '^(data|stringData)$' - | kubectl apply -f - 
    done

Are there better ways of handling decryption of SOPS secrets while working with ArgoCD?

Top 1 comments:
Comment 1:
  Author: hmizael
  Comment: Hi.

https://github.com/viaduct-ai/kustomize-sops#argo-cd-integration

https://argo-cd.readthedocs.io/en/stable/operator-manual/secret-management/
  Score: 1
  Created UTC: 2024-07-23 23:33:13

Note: This post has only 1 comments at the time of scraping.
